<div class="movies-page">
  <div class="container">
    <div class="page-header">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div>
          <h1 class="display-5 fw-bold">Movie Rating System</h1>
          <p class="subtitle">arrange your movie and rating</p>
        </div>
        <div class="d-flex gap-2">
          <%= link_to 'Data Analytics', analytics_path, class: 'btn btn-outline-custom' %>
          <%= link_to 'Add Movie', new_movie_path, class: 'btn btn-custom' %>
        </div>
      </div>
    </div>

    <div class="filters">
      <div class="row">
        <div class="col-md-4">
          <label class="form-label">select category</label>
          <select class="form-select" id="categoryFilter">
            <option value="">all the class</option>
            <% Movie::CATEGORIES.each do |category| %>
              <option value="<%= category %>"><%= category %></option>
            <% end %>
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label">select country</label>
          <select class="form-select" id="countryFilter">
            <option value="">all the nation</option>
            <% Movie::COUNTRIES.each do |country| %>
              <option value="<%= country %>"><%= country %></option>
            <% end %>
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label">select rating</label>
          <select class="form-select" id="ratingFilter">
            <option value="">all the rating</option>
            <option value="5">5 stars</option>
            <option value="4">4 stars and higher</option>
            <option value="3">3 stars and higher</option>
          </select>
        </div>
      </div>
    </div>

    <div class="row" id="moviesGrid">
      <% @movies.each do |movie| %>
        <div class="col-xl-4 col-lg-6 mb-4 movie-item"
             data-category="<%= movie.category %>"
             data-country="<%= movie.country %>"
             data-rating="<%= movie.average_rating.to_i %>">
          <div class="card movie-card h-100">
            <div class="card-header">
              <h5 class="card-title"><%= movie.title %></h5>
              <div class="movie-meta">
                <span class="badge category-badge <%= movie.category %>">
                  <%= movie.category %>
                </span>
                <span class="badge bg-dark"><%= movie.country %></span>
                <span class="badge bg-secondary">üé¨ <%= movie.release_year %></span>
              </div>
            </div>

            <div class="card-body">
              <% if movie.description.present? %>
                <p class="card-text"><%= movie.description %></p>
              <% end %>

              <div class="rating-display">
                <strong class="rating-label">Rating:</strong>
                <div class="rating-value">
                  <span class="rating-number"><%= movie.average_rating || 0 %></span>
                  <span class="rating-max">/5</span>
                </div>
              </div>
            </div>

            <div class="card-footer bg-transparent">
              <div class="btn-group w-100">
                <%= link_to 'Check', movie, class: 'btn btn-outline-light btn-sm' %>
                <%= link_to 'Edit', edit_movie_path(movie), class: 'btn btn-outline-primary btn-sm' %>
                <button type="button" 
                        class="btn btn-outline-danger btn-sm delete-movie-btn"
                        data-movie-id="<%= movie.id %>"
                        data-movie-title="<%= movie.title %>"
                        onclick="initiateDelete(this)">
                  Delete
                </button>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <% if @movies.empty? %>
      <div class="empty-state">
        <div class="empty-icon">üé¨</div>
        <h3>No movies exist yet</h3>
        <p>Start to create!</p>
        <%= link_to 'Add the first movie', new_movie_path, class: 'btn btn-custom btn-lg' %>
      </div>
    <% end %>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">
          <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
          Confirm Deletion
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
          <div class="mb-3">
            <i class="bi bi-trash3-fill text-danger" style="font-size: 3rem;"></i>
          </div>
          <h4 class="mb-2">Are you sure?</h4>
          <p class="mb-3" id="deleteMovieTitle">This action cannot be undone.</p>
          <div class="alert alert-warning mb-0">
            <i class="bi bi-exclamation-circle me-2"></i>
            This will permanently delete the movie from the database.
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i> Cancel
        </button>
        <button type="button" id="confirmDeleteBtn" class="btn btn-danger" onclick="confirmDelete()">
          <i class="bi bi-trash3 me-1"></i> Delete Movie
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// ÂÖ®Â±ÄÂèòÈáè
let currentDeleteMovieId = null;
let currentDeleteElement = null;

// Áõ¥Êé•Âú®ÊåâÈíÆ‰∏äË∞ÉÁî®ÔºåÁ°Æ‰øù‰∫ã‰ª∂Ëß¶Âèë
function initiateDelete(button) {
  console.log('Delete button clicked');
  
  const movieId = button.dataset.movieId;
  const movieTitle = button.dataset.movieTitle;
  currentDeleteMovieId = movieId;
  currentDeleteElement = button.closest('.movie-item');
  
  console.log('Movie ID:', movieId, 'Movie Title:', movieTitle);
  
  // Êõ¥Êñ∞ModalÂÜÖÂÆπ
  const titleElement = document.getElementById('deleteMovieTitle');
  if (titleElement) {
    titleElement.textContent = `Delete "${movieTitle}"?`;
  }
  
  // ÊòæÁ§∫Modal
  const modalElement = document.getElementById('deleteConfirmationModal');
  if (modalElement) {
    console.log('Showing modal');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
  } else {
    console.error('Modal element not found');
  }
}

// Á°ÆËÆ§Âà†Èô§ÂáΩÊï∞
function confirmDelete() {
  console.log('Confirm delete clicked');
  
  if (!currentDeleteMovieId || !currentDeleteElement) {
    console.error('No movie selected for deletion');
    return;
  }
  
  const confirmBtn = document.getElementById('confirmDeleteBtn');
  const originalHtml = confirmBtn.innerHTML;
  confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';
  confirmBtn.disabled = true;
  
  const deleteUrl = `/movies/${currentDeleteMovieId}`;
  console.log('Delete URL:', deleteUrl);
  
  // Ëé∑ÂèñCSRF token
  const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
  console.log('CSRF Token:', csrfToken ? 'Found' : 'Not found');
  
  // ÂèëÈÄÅÂà†Èô§ËØ∑Ê±Ç
  fetch(deleteUrl, {
    method: 'DELETE',
    headers: {
      'X-CSRF-Token': csrfToken,
      'Content-Type': 'application/json',
      'Accept': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    },
    credentials: 'same-origin'
  })
  .then(response => {
    console.log('Response status:', response.status);
    
    if (response.ok) {
      return response.json().then(data => {
        console.log('Delete successful:', data);
        
        // Âä®ÁîªÁßªÈô§ÂÖÉÁ¥†
        currentDeleteElement.style.transition = 'all 0.3s ease';
        currentDeleteElement.style.opacity = '0';
        currentDeleteElement.style.transform = 'scale(0.9)';
        
        setTimeout(() => {
          currentDeleteElement.remove();
          
          // Ê£ÄÊü•ÊòØÂê¶ËøòÊúâÁîµÂΩ±
          if (document.querySelectorAll('.movie-item').length === 0) {
            showEmptyState();
          }
          
          // ÂÖ≥Èó≠Modal
          const modalElement = document.getElementById('deleteConfirmationModal');
          if (modalElement) {
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) modal.hide();
          }
          
          // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
          showMessage('Movie deleted successfully!', 'success');
        }, 300);
      });
    } else {
      return response.json().then(data => {
        console.error('Delete failed:', data);
        throw new Error(data.error || `Delete failed with status: ${response.status}`);
      }).catch(() => {
        throw new Error(`Delete failed with status: ${response.status}`);
      });
    }
  })
  .catch(error => {
    console.error('Delete error:', error);
    showMessage(error.message || 'Failed to delete movie. Please try again.', 'error');
  })
  .finally(() => {
    confirmBtn.innerHTML = originalHtml;
    confirmBtn.disabled = false;
  });
}

// ÂÖ∂‰ªñËæÖÂä©ÂáΩÊï∞
function showEmptyState() {
  const moviesGrid = document.getElementById('moviesGrid');
  if (!moviesGrid) return;
  
  moviesGrid.innerHTML = `
    <div class="col-12">
      <div class="empty-state">
        <div class="empty-icon">üé¨</div>
        <h3>No movies exist yet</h3>
        <p>Start to create!</p>
        <a href="/movies/new" class="btn btn-custom btn-lg">Add the first movie</a>
      </div>
    </div>
  `;
}

function showMessage(message, type) {
  // ÁßªÈô§Áé∞ÊúâÁöÑÊ∂àÊÅØ
  document.querySelectorAll('.alert.position-fixed').forEach(alert => {
    alert.remove();
  });
  
  // ÂàõÂª∫Ê∂àÊÅØÊèêÁ§∫
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed top-0 end-0 m-3`;
  alertDiv.style.zIndex = '9999';
  alertDiv.style.minWidth = '300px';
  alertDiv.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi ${type === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill'} me-2"></i>
      <span class="flex-grow-1">${message}</span>
      <button type="button" class="btn-close ms-2" onclick="this.parentElement.parentElement.remove()"></button>
    </div>
  `;
  
  document.body.appendChild(alertDiv);
  
  // Ëá™Âä®Ê∂àÂ§±
  setTimeout(() => {
    if (alertDiv.parentNode) {
      alertDiv.remove();
    }
  }, 3000);
}

// È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñÁ≠õÈÄâÂäüËÉΩ
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing filters');
  
  // Á≠õÈÄâÂäüËÉΩ
  const filters = ['categoryFilter', 'countryFilter', 'ratingFilter'];
  filters.forEach(id => {
    const filterElement = document.getElementById(id);
    if (filterElement) {
      filterElement.addEventListener('change', filterMovies);
    }
  });

  function filterMovies() {
    const category = document.getElementById('categoryFilter')?.value || '';
    const country = document.getElementById('countryFilter')?.value || '';
    const rating = document.getElementById('ratingFilter')?.value || '';

    document.querySelectorAll('.movie-item').forEach(item => {
      const match =
        (!category || item.dataset.category === category) &&
        (!country || item.dataset.country === country) &&
        (!rating || parseInt(item.dataset.rating) >= parseInt(rating));

      item.style.display = match ? 'block' : 'none';
    });
  }
  
  // ÂàùÂßãÂåñÁ≠õÈÄâ
  filterMovies();
});

// ‰πüÁõëÂê¨ turbo:load ‰∫ã‰ª∂
document.addEventListener('turbo:load', function() {
  console.log('Turbo loaded, reinitializing filters');
  
  // ÈáçÊñ∞ÁªëÂÆöÁ≠õÈÄâ‰∫ã‰ª∂
  const filters = ['categoryFilter', 'countryFilter', 'ratingFilter'];
  filters.forEach(id => {
    const filterElement = document.getElementById(id);
    if (filterElement) {
      // ÂÖàÁßªÈô§ÊóßÁöÑÁõëÂê¨Âô®
      filterElement.replaceWith(filterElement.cloneNode(true));
      // ÈáçÊñ∞ÁªëÂÆö
      document.getElementById(id).addEventListener('change', function() {
        filterMovies();
      });
    }
  });
  
  // ÈáçÊñ∞ËøêË°åÁ≠õÈÄâ
  setTimeout(filterMovies, 100);
});

function filterMovies() {
  const category = document.getElementById('categoryFilter')?.value || '';
  const country = document.getElementById('countryFilter')?.value || '';
  const rating = document.getElementById('ratingFilter')?.value || '';

  document.querySelectorAll('.movie-item').forEach(item => {
    const match =
      (!category || item.dataset.category === category) &&
      (!country || item.dataset.country === country) &&
      (!rating || parseInt(item.dataset.rating) >= parseInt(rating));

    item.style.display = match ? 'block' : 'none';
  });
}
</script>