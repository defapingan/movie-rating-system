<div class="movies-page">
  <div class="container">
    <div class="page-header">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div>
          <h1 class="display-5 fw-bold">Movie Rating System</h1>
          <p class="subtitle">arrange your movie and rating</p>
        </div>
        <div class="d-flex gap-2">
          <%= link_to 'Data Analytics', analytics_path, class: 'btn btn-outline-custom' %>
          <%= link_to 'Add Movie', new_movie_path, class: 'btn btn-custom' %>
        </div>
      </div>
    </div>

    <div class="filters">
      <div class="row">
        <div class="col-md-4">
          <label class="form-label">select category</label>
          <select class="form-select" id="categoryFilter">
            <option value="">all the class</option>
            <% Movie::CATEGORIES.each do |category| %>
              <option value="<%= category %>"><%= category %></option>
            <% end %>
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label">select country</label>
          <select class="form-select" id="countryFilter">
            <option value="">all the nation</option>
            <% Movie::COUNTRIES.each do |country| %>
              <option value="<%= country %>"><%= country %></option>
            <% end %>
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label">select rating</label>
          <select class="form-select" id="ratingFilter">
            <option value="">all the rating</option>
            <option value="5">5 stars</option>
            <option value="4">4 stars and higher</option>
            <option value="3">3 stars and higher</option>
          </select>
        </div>
      </div>
    </div>

    <div class="row" id="moviesGrid">
      <% @movies.each do |movie| %>
        <div class="col-xl-4 col-lg-6 mb-4 movie-item"
             data-category="<%= movie.category %>"
             data-country="<%= movie.country %>"
             data-rating="<%= movie.average_rating.to_i %>">
          <div class="card movie-card h-100">
            <div class="card-header">
              <h5 class="card-title"><%= movie.title %></h5>
              <div class="movie-meta">
                <span class="badge category-badge <%= movie.category %>">
                  <%= movie.category %>
                </span>
                <span class="badge bg-dark"><%= movie.country %></span>
                <span class="badge bg-secondary">ğŸ¬ <%= movie.release_year %></span>
              </div>
            </div>

            <div class="card-body">
              <% if movie.description.present? %>
                <p class="card-text"><%= movie.description %></p>
              <% end %>

              <div class="rating-display">
                <strong class="rating-label">Rating:</strong>
                <div class="rating-value">
                  <span class="rating-number"><%= movie.average_rating || 0 %></span>
                  <span class="rating-max">/5</span>
                </div>
              </div>
            </div>

            <div class="card-footer bg-transparent">
              <div class="btn-group w-100">
                <%= link_to 'Check', movie, class: 'btn btn-outline-light btn-sm' %>
                <%= link_to 'Edit', edit_movie_path(movie), class: 'btn btn-outline-primary btn-sm' %>
                <button type="button" 
                        class="btn btn-outline-danger btn-sm delete-movie-btn"
                        data-movie-id="<%= movie.id %>"
                        data-movie-title="<%= movie.title %>">
                  Delete
                </button>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <% if @movies.empty? %>
      <div class="empty-state">
        <div class="empty-icon">ğŸ¬</div>
        <h3>No movies exist yet</h3>
        <p>Start to create!</p>
        <%= link_to 'Add the first movie', new_movie_path, class: 'btn btn-custom btn-lg' %>
      </div>
    <% end %>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">
          <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
          Confirm Deletion
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
          <div class="mb-3">
            <i class="bi bi-trash3-fill text-danger" style="font-size: 3rem;"></i>
          </div>
          <h4 class="mb-2">Are you sure?</h4>
          <p class="mb-3" id="deleteMovieTitle">This action cannot be undone.</p>
          <div class="alert alert-warning mb-0">
            <i class="bi bi-exclamation-circle me-2"></i>
            This will permanently delete the movie from the database.
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i> Cancel
        </button>
        <button type="button" id="confirmDeleteBtn" class="btn btn-danger">
          <i class="bi bi-trash3 me-1"></i> Delete Movie
        </button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('turbo:load', function() {
  // ç”µå½±ç­›é€‰åŠŸèƒ½
  const filters = ['categoryFilter', 'countryFilter', 'ratingFilter'];
  filters.forEach(id => {
    const filterElement = document.getElementById(id);
    if (filterElement) {
      filterElement.addEventListener('change', filterMovies);
    }
  });

  function filterMovies() {
    const category = document.getElementById('categoryFilter')?.value || '';
    const country = document.getElementById('countryFilter')?.value || '';
    const rating = document.getElementById('ratingFilter')?.value || '';

    document.querySelectorAll('.movie-item').forEach(item => {
      const match =
        (!category || item.dataset.category === category) &&
        (!country || item.dataset.country === country) &&
        (!rating || parseInt(item.dataset.rating) >= parseInt(rating));

      item.style.display = match ? 'block' : 'none';
    });
  }

  // åˆ é™¤ç¡®è®¤åŠŸèƒ½
  let currentDeleteMovieId = null;
  let currentDeleteElement = null;

  // ç›‘å¬æ‰€æœ‰åˆ é™¤æŒ‰é’®çš„ç‚¹å‡»
  document.querySelectorAll('.delete-movie-btn').forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      
      const movieId = this.dataset.movieId;
      const movieTitle = this.dataset.movieTitle;
      currentDeleteMovieId = movieId;
      currentDeleteElement = this.closest('.movie-item');
      
      // æ›´æ–°Modalå†…å®¹
      const titleElement = document.getElementById('deleteMovieTitle');
      if (titleElement) {
        titleElement.textContent = `Delete "${movieTitle}"?`;
      }
      
      // æ˜¾ç¤ºModal
      const modalElement = document.getElementById('deleteConfirmationModal');
      if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      }
    });
  });

  // ç¡®è®¤åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  const confirmBtn = document.getElementById('confirmDeleteBtn');
  if (confirmBtn) {
    confirmBtn.addEventListener('click', function() {
      if (!currentDeleteMovieId || !currentDeleteElement) return;
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      const originalHtml = this.innerHTML;
      this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';
      this.disabled = true;
      
      // æ„å»ºæ­£ç¡®çš„URL
      const deleteUrl = `/movies/${currentDeleteMovieId}`;
      
      // è·å–CSRF token
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
      
      console.log('Deleting movie at URL:', deleteUrl);
      
      // å‘é€åˆ é™¤è¯·æ±‚
      fetch(deleteUrl, {
        method: 'DELETE',
        headers: {
          'X-CSRF-Token': csrfToken,
          'Content-Type': 'application/x-www-form-urlencoded',
          'Accept': 'text/html, application/xhtml+xml'
        },
        credentials: 'same-origin'
      })
      .then(response => {
        console.log('Delete response status:', response.status);
        
        if (response.ok) {
          // ç§»é™¤ç”µå½±å…ƒç´ 
          currentDeleteElement.style.transition = 'all 0.3s ease';
          currentDeleteElement.style.opacity = '0';
          currentDeleteElement.style.transform = 'scale(0.9)';
          
          setTimeout(() => {
            currentDeleteElement.remove();
            
            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ç”µå½±
            if (document.querySelectorAll('.movie-item').length === 0) {
              showEmptyState();
            }
            
            // å…³é—­Modal
            const modalElement = document.getElementById('deleteConfirmationModal');
            if (modalElement) {
              const modal = bootstrap.Modal.getInstance(modalElement);
              if (modal) modal.hide();
            }
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showMessage('Movie deleted successfully!', 'success');
          }, 300);
        } else {
          if (response.status === 404) {
            // ç”µå½±å¯èƒ½å·²è¢«åˆ é™¤ï¼Œç›´æ¥ç§»é™¤å…ƒç´ 
            currentDeleteElement.remove();
            if (document.querySelectorAll('.movie-item').length === 0) {
              showEmptyState();
            }
            const modalElement = document.getElementById('deleteConfirmationModal');
            if (modalElement) {
              const modal = bootstrap.Modal.getInstance(modalElement);
              if (modal) modal.hide();
            }
            showMessage('Movie has been deleted.', 'success');
          } else {
            throw new Error(`Delete failed with status: ${response.status}`);
          }
        }
      })
      .catch(error => {
        console.error('Delete error:', error);
        showMessage('Failed to delete movie. Please try again.', 'error');
      })
      .finally(() => {
        // é‡ç½®æŒ‰é’®çŠ¶æ€
        this.innerHTML = originalHtml;
        this.disabled = false;
      });
    });
  }

  function showEmptyState() {
    const moviesGrid = document.getElementById('moviesGrid');
    if (!moviesGrid) return;
    
    moviesGrid.innerHTML = `
      <div class="col-12">
        <div class="empty-state">
          <div class="empty-icon">ğŸ¬</div>
          <h3>No movies exist yet</h3>
          <p>Start to create!</p>
          <a href="/movies/new" class="btn btn-custom btn-lg">Add the first movie</a>
        </div>
      </div>
    `;
  }

  function showMessage(message, type) {
    // ç§»é™¤ç°æœ‰çš„å›ºå®šä½ç½®æ¶ˆæ¯
    document.querySelectorAll('.alert.position-fixed').forEach(alert => {
      alert.remove();
    });
    
    // åˆ›å»ºæ¶ˆæ¯æç¤º
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed top-0 end-0 m-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.style.minWidth = '300px';
    alertDiv.innerHTML = `
      <div class="d-flex align-items-center">
        <i class="bi ${type === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill'} me-2"></i>
        <span class="flex-grow-1">${message}</span>
        <button type="button" class="btn-close ms-2" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    `;
    
    document.body.appendChild(alertDiv);
    
    // è‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.remove();
      }
    }, 3000);
  }
  
  // Modalå…³é—­æ—¶é‡ç½®çŠ¶æ€
  const modalElement = document.getElementById('deleteConfirmationModal');
  if (modalElement) {
    modalElement.addEventListener('hidden.bs.modal', function() {
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      if (confirmBtn) {
        confirmBtn.innerHTML = '<i class="bi bi-trash3 me-1"></i> Delete Movie';
        confirmBtn.disabled = false;
      }
      currentDeleteMovieId = null;
      currentDeleteElement = null;
    });
  }
  
  // åˆå§‹åŒ–ç­›é€‰
  filterMovies();
});
</script>