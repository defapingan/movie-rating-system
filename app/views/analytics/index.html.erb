<div class="analytics-page">
  <div class="container">
    <div class="page-header">
      <h1 class="display-5 fw-bold">Data Analytics</h1>
      <p class="subtitle">Movie data statistics and visualization</p>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-cards">
      <div class="stat-card">
        <div class="stat-icon">ğŸ¬</div>
        <div class="stat-value"><%= @movies_count %></div>
        <div class="stat-label">Total Movies</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">â­</div>
        <div class="stat-value highlight"><%= @average_rating %></div>
        <div class="stat-label">Average Rating</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">ğŸ“Š</div>
        <div class="stat-value"><%= @categories_count %></div>
        <div class="stat-label">Categories</div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">ğŸŒ</div>
        <div class="stat-value"><%= @countries_count %></div>
        <div class="stat-label">Countries</div>
      </div>
    </div>

    <div class="row">
      <!-- Category Distribution -->
      <div class="col-lg-6 mb-4">
        <div class="chart-card">
          <div class="chart-title">Category Distribution</div>
          <div class="chart-canvas pie">
            <canvas id="categoryChart"></canvas>
          </div>
          <div class="chart-legend">
            <% if @category_data.present? %>
              <% @category_data.each do |category, count| %>
                <div class="legend-item">
                  <div class="legend-color category-<%= category.downcase.parameterize %>"></div>
                  <span><%= category %> (<%= count %>)</span>
                </div>
              <% end %>
            <% else %>
              <div class="text-muted">No category data available</div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Country Distribution -->
      <div class="col-lg-6 mb-4">
        <div class="chart-card">
          <div class="chart-title">Country Distribution</div>
          <div class="chart-canvas pie">
            <canvas id="countryChart"></canvas>
          </div>
          <div class="chart-legend">
            <% if @country_data.present? %>
              <% @country_data.each do |country, count| %>
                <div class="legend-item">
                  <div class="legend-color country-<%= country.downcase.parameterize %>"></div>
                  <span><%= country %> (<%= count %>)</span>
                </div>
              <% end %>
            <% else %>
              <div class="text-muted">No country data available</div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Rating Distribution -->
      <div class="col-lg-6 mb-4">
        <div class="chart-card">
          <div class="chart-title">Rating Distribution</div>
          <div class="chart-canvas bar">
            <canvas id="ratingChart"></canvas>
          </div>
          <div class="rating-distribution">
            <% if @rating_distribution.present? %>
              <% @rating_distribution.each do |rating, percentage| %>
                <div class="distribution-bar">
                  <div class="rating-stars">
                    <% rating.times do %>â˜…<% end %><% (5-rating).times do %>â˜†<% end %>
                  </div>
                  <div class="bar-container">
                    <div class="bar-fill rating-<%= rating %>" style="width: <%= percentage %>%"></div>
                  </div>
                  <div class="percentage"><%= percentage %>%</div>
                </div>
              <% end %>
            <% else %>
              <div class="text-muted">No rating data available</div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Year Statistics -->
      <div class="col-lg-6 mb-4">
        <div class="chart-card">
          <div class="chart-title">Release Year Trend</div>
          <div class="chart-canvas line">
            <canvas id="yearChart"></canvas>
          </div>
          <div class="chart-legend">
            <div class="legend-item">
              <div class="legend-color year-trend"></div>
              <span>Movies per Year</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="text-center mt-4">
      <%= link_to 'Back to Movie List', movies_path, class: 'btn btn-custom' %>
    </div>
  </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// è°ƒè¯•ä¿¡æ¯
console.log('=== Analytics Page Loaded ===');
console.log('Category Data:', <%= raw (@category_data || {}).to_json %>);
console.log('Country Data:', <%= raw (@country_data || {}).to_json %>);
console.log('Rating Data:', <%= raw (@rating_distribution || {}).to_json %>);
console.log('Year Data:', <%= raw (@year_data || {}).to_json %>);

// å…¨å±€å˜é‡å­˜å‚¨å›¾è¡¨å®ä¾‹
window.chartInstances = [];

// ä¸»è¦åˆå§‹åŒ–å‡½æ•°
function initializeAllCharts() {
  console.log('Initializing charts...');
  
  // ç¡®ä¿canvaså…ƒç´ å­˜åœ¨
  const canvases = [
    'categoryChart',
    'countryChart',
    'ratingChart',
    'yearChart'
  ];
  
  let allCanvasesExist = true;
  canvases.forEach(id => {
    if (!document.getElementById(id)) {
      console.error(`Canvas not found: ${id}`);
      allCanvasesExist = false;
    }
  });
  
  if (!allCanvasesExist) {
    console.log('Some canvases missing, retrying in 500ms...');
    setTimeout(initializeAllCharts, 500);
    return;
  }
  
  // é”€æ¯ç°æœ‰å›¾è¡¨
  destroyAllCharts();
  
  // åˆå§‹åŒ–å„ä¸ªå›¾è¡¨
  initializeCategoryChart();
  initializeCountryChart();
  initializeRatingChart();
  initializeYearChart();
  
  console.log('Charts initialized successfully');
}

// é”€æ¯æ‰€æœ‰å›¾è¡¨
function destroyAllCharts() {
  if (window.chartInstances && window.chartInstances.length > 0) {
    window.chartInstances.forEach(chart => {
      try {
        if (chart && typeof chart.destroy === 'function') {
          chart.destroy();
        }
      } catch (e) {
        console.warn('Error destroying chart:', e);
      }
    });
    window.chartInstances = [];
  }
}

// ç±»åˆ«åˆ†å¸ƒå›¾è¡¨
function initializeCategoryChart() {
  const ctx = document.getElementById('categoryChart').getContext('2d');
  
  // è·å–æ•°æ®
  const rawData = <%= raw (@category_data || {}).to_json %>;
  const labels = Object.keys(rawData);
  const data = Object.values(rawData);
  
  if (labels.length === 0) {
    console.warn('No category data available');
    showNoDataMessage('categoryChart', 'No category data');
    return;
  }
  
  // é¢œè‰²æ˜ å°„ï¼ˆä¸CSSä¿æŒä¸€è‡´ï¼‰
  const colorMap = {
    'sciencefiction': '#3b82f6',
    'mystery': '#ef4444',
    'art': '#10b981',
    'comedy': '#f59e0b',
    'others': '#6b7280'
  };
  
  const backgroundColors = labels.map(label => {
    const key = label.toLowerCase().replace(/\s+/g, '');
    return colorMap[key] || getRandomColor(label);
  });
  
  const chart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: backgroundColors,
        borderWidth: 2,
        borderColor: 'rgba(15, 23, 42, 0.9)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.95)',
          titleColor: '#f8fafc',
          bodyColor: '#cbd5e1',
          borderColor: 'var(--purple)',
          borderWidth: 1,
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.raw || 0;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
              return `${label}: ${value} (${percentage}%)`;
            }
          }
        }
      }
    }
  });
  
  window.chartInstances.push(chart);
}

// å›½å®¶åˆ†å¸ƒå›¾è¡¨
function initializeCountryChart() {
  const ctx = document.getElementById('countryChart').getContext('2d');
  
  const rawData = <%= raw (@country_data || {}).to_json %>;
  const labels = Object.keys(rawData);
  const data = Object.values(rawData);
  
  if (labels.length === 0) {
    showNoDataMessage('countryChart', 'No country data');
    return;
  }
  
  // å›½å®¶é¢œè‰²æ˜ å°„
  const countryColorMap = {
    'unitedstates': '#dc2626',
    'unitedkingdom': '#1d4ed8',
    'japan': '#3b82f6',
    'china': '#ef4444',
    'france': '#059669',
    'india': '#7c3aed',
    'germany': '#f59e0b',
    'southkorea': '#ec4899',
    'canada': '#06b6d4',
    'australia': '#84cc16'
  };
  
  const backgroundColors = labels.map(label => {
    const key = label.toLowerCase().replace(/\s+/g, '');
    return countryColorMap[key] || getRandomColor(label);
  });
  
  const chart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: backgroundColors,
        borderWidth: 2,
        borderColor: 'rgba(15, 23, 42, 0.9)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '50%',
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.95)',
          titleColor: '#f8fafc',
          bodyColor: '#cbd5e1'
        }
      }
    }
  });
  
  window.chartInstances.push(chart);
}

// è¯„åˆ†åˆ†å¸ƒå›¾è¡¨
function initializeRatingChart() {
  const ctx = document.getElementById('ratingChart').getContext('2d');
  
  const rawData = <%= raw (@rating_distribution || {}).to_json %>;
  const labels = ['5 Stars', '4 Stars', '3 Stars', '2 Stars', '1 Star'];
  const data = [
    rawData[5] || 0,
    rawData[4] || 0,
    rawData[3] || 0,
    rawData[2] || 0,
    rawData[1] || 0
  ];
  
  // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
  const hasData = data.some(value => value > 0);
  if (!hasData) {
    showNoDataMessage('ratingChart', 'No rating data');
    return;
  }
  
  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: [
          'rgba(34, 197, 94, 0.9)',
          'rgba(134, 239, 172, 0.9)',
          'rgba(253, 224, 71, 0.9)',
          'rgba(251, 191, 36, 0.9)',
          'rgba(248, 113, 113, 0.9)'
        ],
        borderColor: [
          '#16a34a',
          '#4ade80',
          '#eab308',
          '#f59e0b',
          '#ef4444'
        ],
        borderWidth: 2,
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.raw}% of movies`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          ticks: {
            color: '#9ca3af',
            callback: function(value) {
              return value + '%';
            }
          },
          grid: {
            color: 'rgba(255, 255, 255, 0.1)'
          }
        },
        x: {
          ticks: {
            color: '#9ca3af'
          },
          grid: {
            display: false
          }
        }
      }
    }
  });
  
  window.chartInstances.push(chart);
}

// å¹´ä»½è¶‹åŠ¿å›¾è¡¨
function initializeYearChart() {
  const ctx = document.getElementById('yearChart').getContext('2d');
  
  const rawData = <%= raw (@year_data || {}).to_json %>;
  const labels = Object.keys(rawData).sort();
  const data = labels.map(year => rawData[year]);
  
  if (labels.length === 0) {
    showNoDataMessage('yearChart', 'No year data');
    return;
  }
  
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Movies Released',
        data: data,
        borderColor: '#764ba2',
        backgroundColor: 'rgba(118, 75, 162, 0.15)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointBackgroundColor: '#667eea',
        pointBorderColor: '#ffffff',
        pointBorderWidth: 2,
        pointRadius: 6,
        pointHoverRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          mode: 'index',
          intersect: false,
          backgroundColor: 'rgba(15, 23, 42, 0.95)'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            color: '#9ca3af'
          },
          grid: {
            color: 'rgba(255, 255, 255, 0.1)'
          }
        },
        x: {
          ticks: {
            color: '#9ca3af'
          },
          grid: {
            color: 'rgba(255, 255, 255, 0.1)'
          }
        }
      },
      interaction: {
        intersect: false,
        mode: 'nearest'
      }
    }
  });
  
  window.chartInstances.push(chart);
}

// æ˜¾ç¤ºæ— æ•°æ®æ¶ˆæ¯
function showNoDataMessage(canvasId, message) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  ctx.font = '14px "Segoe UI", system-ui, sans-serif';
  ctx.fillStyle = '#9ca3af';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(message, canvas.width / 2, canvas.height / 2);
}

// éšæœºé¢œè‰²ç”Ÿæˆ
function getRandomColor(seed) {
  const colors = [
    '#3b82f6', '#ef4444', '#f59e0b', '#10b981', '#8b5cf6',
    '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'
  ];
  
  let hash = 0;
  for (let i = 0; i < seed.length; i++) {
    hash = seed.charCodeAt(i) + ((hash << 5) - hash);
  }
  
  return colors[Math.abs(hash) % colors.length];
}

// Turboäº‹ä»¶å¤„ç†
document.addEventListener('turbo:load', function() {
  console.log('Turbo:load event fired');
  if (document.querySelector('.analytics-page')) {
    // å»¶è¿Ÿåˆå§‹åŒ–ä»¥ç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
    setTimeout(initializeAllCharts, 100);
  }
});

// ä¼ ç»ŸDOMåŠ è½½äº‹ä»¶
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOMContentLoaded event fired');
  if (document.querySelector('.analytics-page')) {
    setTimeout(initializeAllCharts, 300);
  }
});

// é¡µé¢å¯è§æ€§å˜åŒ–æ—¶é‡æ–°åˆå§‹åŒ–
document.addEventListener('visibilitychange', function() {
  if (document.visibilityState === 'visible' && document.querySelector('.analytics-page')) {
    console.log('Page became visible, reinitializing charts');
    setTimeout(initializeAllCharts, 200);
  }
});

// çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°ç»˜åˆ¶
let resizeTimer;
window.addEventListener('resize', function() {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(function() {
    if (document.querySelector('.analytics-page') && window.chartInstances.length > 0) {
      console.log('Window resized, updating charts');
      window.chartInstances.forEach(chart => {
        try {
          chart.resize();
        } catch (e) {
          console.warn('Error resizing chart:', e);
        }
      });
    }
  }, 250);
});

// åˆå§‹åŠ è½½æ—¶å°è¯•åˆå§‹åŒ–
if (document.querySelector('.analytics-page')) {
  console.log('Analytics page found on initial load');
  setTimeout(initializeAllCharts, 500);
}
</script>